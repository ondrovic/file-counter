name: testing

on:
  pull_request:
  push:
    branches: [master]
    tags-ignore: "*"

jobs:
  testing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Install depednecies
        run: go mod download

      - name: Install go-covr
        run: |
          echo "::add-mask::$GITHUB_TOKEN"
          go install github.com/mattn/go-covr@latest

      - name: Run tests
        run: go test -v -coverprofile=coverage.out ./...

      - name: Convert to Cobertura format
        run: go-covr -format=cobertura -i coverage.out -o coverage.cobertura.xml

      - name: Code Coverage Report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: "*.coverage.cobertura.xml"
          badge: true
          fail_below_min: true
          format: markdown
          hide_branch_rate: true
          hide_complexity: false
          indicators: true
          output: both

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
